//
//  MulticallTests.swift
//  
//
//  Created by Yuri on 03.06.2023.
//
import XCTest
@testable import SmartContract

final class MulticallTests: XCTestCase {

    let wrappedETH = EthereumAddress("0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2")!
    let url =  URL(string: "https://rpc.payload.de")!
    let address = "0xeefba1e63905ef1d7acba5a8513c70307c1ce441"
    
    func testEncodeCallAbi() throws {
        let contract = MulticallContract()
        let erc20 = ERC20Contract()
        let calls: [MulticallContract.Call] = [
            .init(address: wrappedETH, bytes: try erc20.abi("name")),
            .init(address: wrappedETH, bytes: try erc20.abi("symbol"))
        ]

        XCTAssertEqual(try contract.contract.function("aggregate").methodName, "aggregate((address,bytes)[])")
        XCTAssertEqual(try contract.contract.function("aggregate").signature(), "0x252dba42")
        
        let sample =
        """
        0x252dba42
        0000000000000000000000000000000000000000000000000000000000000020
        0000000000000000000000000000000000000000000000000000000000000002
        0000000000000000000000000000000000000000000000000000000000000040
        00000000000000000000000000000000000000000000000000000000000000c0
        000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2
        0000000000000000000000000000000000000000000000000000000000000040
        0000000000000000000000000000000000000000000000000000000000000004
        06fdde0300000000000000000000000000000000000000000000000000000000
        000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2
        0000000000000000000000000000000000000000000000000000000000000040
        0000000000000000000000000000000000000000000000000000000000000004
        95d89b4100000000000000000000000000000000000000000000000000000000
        """.split(separator: "\n").joined()
        
        let abi = try contract.aggregateAbi(calls).hexString
        XCTAssertEqual(abi, sample)
    }
    
    func testDecodeAggregate() throws {
        let answer = "000000000000000000000000000000000000000000000000000000000109d0b200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000d57726170706564204574686572000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000045745544800000000000000000000000000000000000000000000000000000000"
        
        let values = try MulticallContract().contract.function("aggregate").decodeOutput(answer)
        XCTAssertEqual(values.count, 2)
    }
    
    func testCall() async throws {
        let rpc = RPC(url: url)
        let contract = MulticallContract(rcp: rpc, address: address)
        let erc20 = ERC20Contract()
        let calls: [MulticallContract.Call] = [
            .init(address: wrappedETH, bytes: try erc20.abi("name")),
            .init(address: wrappedETH, bytes: try erc20.abi("symbol"))
        ]
        
        let result = try await contract.aggregate(calls)
        
        let answer = "000000000000000000000000000000000000000000000000000000000109d0b200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000d57726170706564204574686572000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000045745544800000000000000000000000000000000000000000000000000000000"
        
        // Block number will be different each time so we need drop it
        XCTAssertEqual(result.dropFirst(66), answer.dropFirst(64))
    }
    
}

/*
        000000000000000000000000000000000000000000000000000000000109d080 // Block number uint256
 
        0000000000000000000000000000000000000000000000000000000000000040 // Offset of array (2 * 32)
 
        0000000000000000000000000000000000000000000000000000000000000002 // Array - elements count 2
        0000000000000000000000000000000000000000000000000000000000000040 // First element offset (32 * 2)
        00000000000000000000000000000000000000000000000000000000000000c0 // Second element offset (32 * 6)
 
        0000000000000000000000000000000000000000000000000000000000000060 // Total size or next element dynamic bytes
        0000000000000000000000000000000000000000000000000000000000000020 // Offset of element - 32 bytes
        000000000000000000000000000000000000000000000000000000000000000d // length of name
        5772617070656420457468657200000000000000000000000000000000000000 // Name "Wrapped Ether"
 
        0000000000000000000000000000000000000000000000000000000000000060 // ???
        0000000000000000000000000000000000000000000000000000000000000020 // Offset of element - 32 bytes
        0000000000000000000000000000000000000000000000000000000000000004 // Length of symbol
        5745544800000000000000000000000000000000000000000000000000000000 // Symbol "WETH"
 */
